<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Posts | JiansLife</title>
<meta name="keywords" content="">
<meta name="description" content="Posts - JiansLife">
<meta name="author" content="chiba">
<link rel="canonical" href="https://chibataiki.github.io/posts/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://chibataiki.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://chibataiki.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://chibataiki.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://chibataiki.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://chibataiki.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" type="application/rss+xml" href="https://chibataiki.github.io/posts/index.xml">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Posts" />
<meta property="og:description" content="JiansLife Blog" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://chibataiki.github.io/posts/" /><meta property="og:site_name" content="JiansLife" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Posts"/>
<meta name="twitter:description" content="JiansLife Blog"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://chibataiki.github.io/posts/"
    }
  ]
}
</script>
</head>

<body class="list dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://chibataiki.github.io/" accesskey="h" title="JiansLife (Alt + H)">JiansLife</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://chibataiki.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://chibataiki.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://chibataiki.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://chibataiki.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main"> 
<header class="page-header"><div class="breadcrumbs"><a href="https://chibataiki.github.io/">Home</a></div>
  <h1>
    Posts
  </h1>
</header>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Emulate_iot_programs_with_qiling_1
    </h2>
  </header>
  <div class="entry-content">
    <p>[TOC]
前段时间挖掘的一个栈溢出漏洞，最近准备用qiling仿真一下顺便写下exp，不过后面发现漏洞已经公开了。
漏洞简要描述 device_discover 监听 udp端口5001, 处理接收到的数据。
在数据处理函数protocol_packet_handle中，存在一些校验函数，会对数据进行初步的校验，校验方式基于对数据header特定字节的对比和checksum对比完成。header结构和checksum算法可以通过逆向解析，可以绕过该校验。
在协议解析函数parse_discovery_frame，parse_advertisement_frame中会调用parse_msg_element 对数据进行解析。parse_msg_element 解析udp中数据时会调用copy_msg_element。
copy_msg_element函数中未对memcpy长度进行校验，导致栈溢出漏洞。
int __fastcall copy_msg_element(int a1, void *a2, signed int a3) { if ( !a1 || !a2 || a3 &lt; 0 ) return 1; memcpy(a2, (const void *)(a1 &#43; 4), a3); return 0; } 使用qiling进行仿真 具体实现放在github 上 https://github.com/chibataiki/IoT_emulating/tree/main/ql_tplink_device_discover
大概需要hook 的一些点：
device_discover 会 bind br0，这里可以patch 为 lo, 或者添加个虚拟网络接口 br0
patch
ql.patch(0x0040BAC0, b&#39;lo\x00&#39;) add br0
sudo modprobe dummy sudo ip link add br0 type dummy sudo ip addr change dev br0 192....</p>
  </div>
  <footer class="entry-footer"><span title='2022-10-07 21:39:26 +0800 CST'>October 7, 2022</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to Emulate_iot_programs_with_qiling_1" href="https://chibataiki.github.io/posts/emulate_iot_programs_with_qiling_1/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Firmware emulation tools
    </h2>
  </header>
  <div class="entry-content">
    <p>Collect some firmware emulation tools. Add some more analysis later.
[TOC]
QEMU user mode system mode Firmadyne https://github.com/firmadyne/firmadyne a research-paper project FirmAE https://github.com/pr0v3rbs/FirmAE EMUX (formerly ARMX) https://github.com/therealsaumil/emux Firmware Analysis Toolkit https://github.com/attify/firmware-analysis-toolkit Qiling https://github.com/qilingframework/qiling unicorn https://github.com/unicorn-engine/unicorn basesafe https://github.com/fgsect/BaseSAFE a research-paper project FirmWire https://github.com/FirmWire/FirmWire.git for smartphone baseband firmwares usercore https://github.com/lunixbochs/usercorn no more commits since 20 Mar 2019 binee https://github.com/carbonblack/binee no more commits since 15 Jun 2020 </p>
  </div>
  <footer class="entry-footer"><span title='2022-02-16 15:00:44 +0800 CST'>February 16, 2022</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to Firmware emulation tools" href="https://chibataiki.github.io/posts/firmware_emulation_tools/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>SSD漏洞挖掘从入门到放弃
    </h2>
  </header>
  <div class="entry-content">
    <p>0x00 前研 参加了 “雷克沙杯”HL260s移动硬盘破解挑战赛，记录一下整个过程。
0x01 SSD 组成部分 包含存储芯片部分和USB-to-SATA 转接器两个部分。
存储芯片部分包含4片 longsys 128GB 存储，一共512GB
桥接器芯片正面，包含一个 SOP8的SPI-flash， 另一个芯片不清楚。
​	反面包含一颗 SATA-to-USB 桥接器芯片。
0x02 flash 固件 分析 提取后包含部分 USB descriptor 明文信息和加密固件
USB descriptor:
​	可以得出bridge controller 为 Initio INIC-3638
​	结合芯片信息 符合lexar 相关介绍，但是没有对应datasheet
​
剩下部分为加密固件
0x03 读取分区 使用lexar 原装的 usb-to-sata bridge，可以发现只能识别256GB的块区
usb 2-4.3: New USB device found, idVendor=21c4, idProduct=b061, bcdDevice= 3.06 usb 2-4.3: New USB device strings: Mfr=1, Product=2, SerialNumber=3 usb 2-4.3: Product: HL260S usb 2-4....</p>
  </div>
  <footer class="entry-footer"><span title='2022-01-21 15:13:32 +0800 CST'>January 21, 2022</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to SSD漏洞挖掘从入门到放弃" href="https://chibataiki.github.io/posts/ssd%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>The Design of Metro Map
    </h2>
  </header>
  <div class="entry-content">
    <p>伦敦交通图的最初几个版本很复杂，包含了很多要素:
河流，公园，树木，道路等等，很精确但是要素过多。乘坐地铁的人们显然更加在意如何从一个地铁站到达另一个地铁站。
Harry Beck 设计的地铁图：
三种方向： 上下，左右，以及斜45度。将复杂的地图简化为清晰的几何。在协调一致和特殊要求直接找到了一个很好的平衡。也成为了现代地铁示意图的典范。
referer:
https://www.ted.com/talks/michael_bierut_the_genius_of_the_london_tube_map/transcript?language=en&amp;referrer=playlist-small_thing_big_idea#t-67176
《设计，无处不在》</p>
  </div>
  <footer class="entry-footer"><span title='2020-08-22 20:24:49 +0800 CST'>August 22, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to The Design of Metro Map" href="https://chibataiki.github.io/posts/the-design-of-metro-map/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>FREAK
    </h2>
  </header>
  <div class="entry-content">
    <p>introduction FREAK:(Factoring RSA Export Keys ) 在SSL/TLS协议中存在一种漏洞,允许中间人将ciphersuite中的RSA强度降低为EXPORT-grade(出口级别).
早期由于二战的因素,许多国家出于国家安全因素的考虑,从而限制加密技术的出口;美国政府对出口的加密算法存在限制, 根据法律将出口的RSA密钥长度减少为512bits.而512bit的RSA密钥解密的代价很小,允许美国可以解密国外的加密通讯.
受漏洞影响的相关库:
OpenSSL :CVE-2015-0204 1.0.1-1.0.1j, 1.0.0-1.0.0o,0.9.8-0.9.8zc BoringSSL: versions before Nov 10, 2014 are vulnerable … 在 OpenSSL 库中，s3_clnt.c 文件中的 ssl3_get_key_exchange 函数允许客户端使用弱RSA密钥对。攻击者可拦截受影响的客户端与服务器之间的HTTPS连接，并强制其使用弱加密。
patch部分: https://github.com/openssl/openssl/commit/ce325c60c74b0fa784f5872404b722e120e5cab0
攻击流程 client在发送的client hello中使用标准的RSA加密请求 MITM 劫持client hello,并将cipher suite 更改为 export-grade RSA,比如TLS_RSA_EXPORT_WITH_RC4_MD5,并传给server server在ServerCertificate中发送2048bits的公钥，接受export级别的cipher suite,并临时生成512bit的RSA公钥, 通过发送ServerKeyExchange message通知client,并使用证书的密钥对公钥进行签名 client端接受消息,验证证书, 生成 premaster key并通过server端的公钥进行加密 mitm attacker需要将512bit的公钥进行因数分解获得临时私钥, mitm 此时可以从clientkeyexchange中解密出pre-master secret 成功解密后attacker可以明文查看所有信息 检测方式:
服务端:
openssl s_client -connect [server ip] -cipher EXPORT 客户端 https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html 实验 使用 netfilterqueue 能够劫持TLS/SSL 握手包，可以通过scapy对数据包进行过滤和修改，可以将ciphersuite 更换为自己想要的版本...</p>
  </div>
  <footer class="entry-footer"><span title='2020-07-16 18:12:05 +0800 CST'>July 16, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to FREAK" href="https://chibataiki.github.io/posts/freak/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Sslstrip Use Note
    </h2>
  </header>
  <div class="entry-content">
    <p>sslstrip is a MITM tool.
how it works People may not type https:// (http://) in the address bar.
offen encouter SSL with this two types:
301/302 redirection click links with https:// sslstrip can watch http traffic and change all https links to http
arpspoof send ARP messages on LAN associate the attacker’s Mac address with the gateway ip, then all traffic will send too attacker’s machine
sudo arpspoof -i [interface] -t [target mac] -r [gataway mac] traffic redirect sudo iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 10000 referer:...</p>
  </div>
  <footer class="entry-footer"><span title='2020-06-09 09:16:47 +0800 CST'>June 9, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to Sslstrip Use Note" href="https://chibataiki.github.io/posts/sslstrip-use-note/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Mitmproxy Use Note
    </h2>
  </header>
  <div class="entry-content">
    <p>一般而言,直接看官方文档就能解决很多问题, 但是实际测试中还是踩了很多坑,所以记录一下
环境: ubuntu 20.04
安装 坑: pip安装存在问题, 需要pipx
how mitm works https://docs.mitmproxy.org/stable/concepts-howmitmproxyworks/
certificate 安装mitmproxy的时候会在 .mitmproxy中默认生产很多认证相关的文件. ubuntu需要手动信任一下
放到/usr/share/ca-certificates目录下 sudo dpkg-reconfigure ca-certificates 流量转发 开启转发:
sysctl -w net.ipv4.ip_forward=1 sysctl -w net.ipv6.conf.all.forwarding=1 关闭 ICMP包的转发
sysctl -w net.ipv4.conf.all.send_redirects=0 流量转发存在很多形式: https://docs.mitmproxy.org/stable/concepts-modes/
这里讲一下 Transparent的相关问题
选择本地转发的话: 直接iptables 转发流量会遇到的一个问题就是循环转发 iptables -t nat -A OUTPUT -p tcp -dport 80 -j REDIRECT --to-port 8080 这里8080是mitmproxy的代理端口, 所有出去的流量都会转发到8080,但是mitmproxy也需要访问80端口.
所以一个解决方案是新建一个用户mitmproxyuser,让它执行mitmproxy, 然后iptables设置一下不要过滤用户:mitmproxyuser,就可以解决流量循环转发的问题
sudo useradd mitmproxyuser passwd mitmproxyuser iptables -t nat -A OUTPUT -p tcp -m owner !...</p>
  </div>
  <footer class="entry-footer"><span title='2020-06-08 17:21:54 +0800 CST'>June 8, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to Mitmproxy Use Note" href="https://chibataiki.github.io/posts/mitmproxy-use-note/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Ghidra Usage Note
    </h2>
  </header>
  <div class="entry-content">
    <p>Ghidra plugin for ida ghidra包含了一些用于IDA的插件: 位于 ${GHIDRA_DIR}/Extensions/IDAPro/Python/
mac下插件位置: /Users/$USER/.idapro/plugins/
xml_exporter.py: 1.a plugin to export an IDA database as an XML file.
2.Place in the IDA plugins folder.
xml_loader.py 1.an IDA loader to build a new database using an XML file.
2.It loads the .bytes file and builds the IDA database using the contents of the XML file.
3.NOTE: Currently, the loader does not support importing memory overlays or Harvard architectures (e....</p>
  </div>
  <footer class="entry-footer"><span title='2020-06-01 13:22:15 +0800 CST'>June 1, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to Ghidra Usage Note" href="https://chibataiki.github.io/posts/ghidra-usage-note/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>IDA_usage_note
    </h2>
  </header>
  <div class="entry-content">
    <p>对于IDA不能识别的二进制文件, 可以选择作为binary file 进行加载.
需要:
手动设置CPU架构 手动设置加载基址 一旦IDA加载了文件,那么首先做的就是在最开头按下c, 将其转为code.
IDA会将二进制文件的bytes转为code然后进行分析, 但是任然会存在很多没有解析的code.
自动分析binary file 从固件中找到对应的符号文件, 使用IDApython进行符号的修复
TODO referer:
http://www.devttys0.com/2011/07/reverse-engineering-vxworks-firmware-wrt54gv8/</p>
  </div>
  <footer class="entry-footer"><span title='2020-05-28 10:30:54 +0800 CST'>May 28, 2020</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to IDA_usage_note" href="https://chibataiki.github.io/posts/ida_usage_note/"></a>
</article>

<article class="post-entry"> 
  <header class="entry-header">
    <h2>Tp_Link_wr886nv6_VxWorks_firmware_analysis
    </h2>
  </header>
  <div class="entry-content">
    <p>文件系统的提取 看第一篇参考文献的时候,尝试了下,找到了Tp_Link_wr886nv6的固件.
binwalk 扫描结果:
考虑到wr886nv6的内存空间, 这个解压大小2M左右的lzma压缩文件就可能比较有意思.
但是根据binwalk的两个文件初始位置进行分割会有点小问题,所以需要通过hex查看一下真实的有效数据是多大. 类似于这样: 真实数据到 0x00b6b2就结束了
000b6280: 500f 1765 1fee 46eb f9ca c213 2911 9afe P..e..F.....)... 000b6290: 3930 5afb 6f5c 6563 9742 d169 e313 e5ba 90Z.o\ec.B.i.... 000b62a0: 030b ba40 fb20 2705 c2c4 64d9 fe98 78de ...@. &#39;...d...x. 000b62b0: be68 ffff ffff ffff ffff ffff ffff ffff .h.............. ... 000b6ff0: ffff ffff ffff ffff ffff ffff ffff ffff ................ 000b7000: 4d49 4e49 4653 0000 0000 0000 0000 0000 MINIFS....</p>
  </div>
  <footer class="entry-footer"><span title='2020-05-27 16:21:44 +0800 CST'>May 27, 2020</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;chiba</footer>
  <a class="entry-link" aria-label="post link to Tp_Link_wr886nv6_VxWorks_firmware_analysis" href="https://chibataiki.github.io/posts/tp-link_wr886nv6_vxworks_firmware_analysis/"></a>
</article>
<footer class="page-footer">
  <nav class="pagination">
    <a class="next" href="https://chibataiki.github.io/posts/page/2/">Next&nbsp;&nbsp;»
    </a>
  </nav>
</footer>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="https://chibataiki.github.io/">JiansLife</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
